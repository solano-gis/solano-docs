---
title: "Map Protocol"
description: "PostMessage contract between sage-web and sage-map"
---

sage-web and sage-map communicate via `window.postMessage`. This is the contract for the shared map — the AI controls a map that the user sees, and the user interacts with a map that the AI sees.

## Transport rules

All messages must include:

| Field | Required | Value |
|-------|----------|-------|
| `source` | Yes | `'sage-chat'` (parent) or `'sage-map'` (iframe) |
| `type` | Yes | Message discriminator (see registry below) |
| `mapId` | iframe→parent | Identifies which map instance sent the message |
| `payload` | Yes | Message data object |

Origins are allowlisted on both sides (`SAGE_MAP_ORIGIN` in production, `localhost` in dev).

## Message registry

### Iframe → Parent

| Type | Payload | When |
|------|---------|------|
| `map-ready` | `{ version }` | Iframe loaded, ready for commands. Parent flushes queued commands. |
| `view-changed` | `MapStateSnapshot` | Debounced updates while user pans/zooms. |
| `state-snapshot` | `MapStateSnapshot` | Response to explicit `request-state`. |
| `command-ack` | `{ commandId, commandType, applied, details }` | Command completed. `details.screenshotDataUrl` included when available. |
| `parcel-clicked` | `ParcelClickedPayload` | User clicked a parcel. |
| `identify-result` | `IdentifyResultPayload` | User clicked identify — all features at point + screenshot. Triggers AI auto-send. |
| `selection-changed` | `SelectionPayload` | Shift+click add/remove/clear. All selected features + count + action type. |
| `screenshot` | `{ dataUrl, error? }` | Response to `request-screenshot` (fallback path). |
| `stroke-added` | `{ strokeCount }` | User completed a freehand stroke. Lightweight — no screenshot. |
| `sketch-summary` | `SketchSummaryPayload` | Response to `get-sketch-summary`. Per-stroke bounding boxes + screenshot. |

### Parent → Iframe

| Type | Payload | When |
|------|---------|------|
| `map-command` | `{ commandId, command }` | Typed `MapCommand` union — the AI controlling the map. |
| `request-state` | `{}` | Ask iframe to post current `state-snapshot`. |
| `request-screenshot` | `{ width, height }` | Manual screenshot (fallback if command-ack missed). |

## MapCommand types

The `command` field in `map-command` is a discriminated union:

| Command | Parameters | Effect |
|---------|-----------|--------|
| `goto` | `center`, `zoom`, `apn`, `apns`, `extent` | Navigate to location |
| `highlight-apns` | `apns[]` | Highlight parcels by APN (orange outlines) |
| `highlight-features` | `url`, `where`, `layerTitle?`, `maxFeatures?` | Highlight any queryable features by SQL WHERE expression |
| `clear-highlights` | — | Remove all highlights |
| `set-layers-visible` | `layers: [{ title, visible }]` | Toggle layer visibility |
| `add-layer` | `url`, `title`, `layerType`, `opacity` | Add external service overlay |
| `remove-layer` | `title` | Remove an added overlay |
| `set-preset` | `preset` | Switch entire web map (parcels, planning, hazards, master) |
| `annotate` | `annotations[]`, `id?` | Draw AI annotations (markers, lines, polygons, circles, labels) |
| `clear-annotations` | `id?` | Clear all annotations, or only a specific group by ID |
| `start-sketch` | `tool` | Start user freehand drawing (`freehand`) |
| `cancel-sketch` | — | Cancel active sketch tool |
| `clear-sketch` | — | Clear all user-drawn strokes |
| `get-sketch-summary` | — | Request per-stroke bounding boxes + screenshot |

### highlight-features

Feature selection via SQL WHERE expressions. Unlike `highlight-apns` (which only handles parcels by APN), this command queries any FeatureServer URL and highlights matching features with geometry-adaptive symbols:

- **Polygon** — transparent fill, orange 3px outline
- **Polyline** — orange 3px line
- **Point** — orange circle marker, size 10, white outline

The AI constructs WHERE expressions from domain knowledge (e.g., `zone_abrev = 'R-1'`, `HAZ_CLASS = 'Very High'`). sage-web resolves layer titles to FeatureServer URLs via its layer registry before sending the command. The `maxFeatures` cap (default 5,000) prevents runaway queries. The query uses `maxRecordCountFactor: 5` to override the typical ArcGIS REST `maxRecordCount` limit (often 1,000–2,000).

### annotate

AI-drawn annotations on a dedicated `GraphicsLayer`:

| Type | Parameters | Rendering |
|------|-----------|-----------|
| `marker` | `latitude`, `longitude`, `label?` | Circle marker + optional text |
| `line` | `path: [lat, lon][]` | Polyline with jitter |
| `polygon` | `rings: [lat, lon][][]` | Outline (or filled) with jitter |
| `circle` | `latitude`, `longitude`, `radiusFeet` | Geodesic buffer with jitter |
| `label` | `latitude`, `longitude`, `text` | Text with white halo |

Color palette: `crimson`, `emerald`, `cobalt`, `violet`, `teal`, `slate`. No free-form hex — orange excluded. Lines, polygons, and circles get **vertex subdivision + seeded jitter** for a hand-drawn look. See [The Shared Canvas](/integration/shared-canvas) for design rationale.

### get-sketch-summary

Returns per-stroke bounding boxes from the user's freehand drawings:

```
SketchSummaryPayload {
  strokes: StrokeSummary[]
  strokeCount: number
  screenshotDataUrl?: string
}

StrokeSummary {
  bbox: { north, south, east, west }
  centroid: { latitude, longitude }
}
```

Called at message-send time when strokes exist. Summaries + screenshot injected into AI context.

## Command lifecycle

```
 1. Parent creates commandId, clears stale ack screenshots
 2. Parent posts map-command, records send timestamp
 3. If iframe not ready, command queued until map-ready
 4. Iframe receives command, adds to FIFO queue
 5. Iframe executes command, waits for render settle
 6. Iframe captures screenshot (1092×1092 JPEG, 75%)
 7. Iframe sends command-ack with screenshotDataUrl
 8. Parent correlates ack to commandId, stores screenshot
 9. Parent reports tool output to AI with ackStatus
10. Screenshot attached to next AI context
```

### Ack-before-output

The parent **waits for the iframe's command-ack before reporting success to the AI**. This is critical — without it, the AI sees "Map updated" immediately and hallucinates a description of what it "sees" before any screenshot arrives. If the iframe bridge is broken (origin mismatch, deployment protection, iframe not loaded), the AI would describe a map state that doesn't exist.

`ToolResult.tsx` calls `waitForCommandAck(commandId, 8000)` and reports one of three statuses in the tool output:

| `ackStatus` | Meaning | AI behavior |
|-------------|---------|-------------|
| `confirmed` | Iframe processed command, screenshot available | AI can describe what it sees |
| `unconfirmed` | 8s timeout — iframe may be dead | AI tells user the command wasn't confirmed |
| `failed` | `sendCommand` returned null (no iframe) | AI tells user the map isn't available |

The system prompt instructs the AI to never describe map contents when `ackStatus` is `unconfirmed` or `failed`.

### Ack payload semantics

- `applied: true` — command completed as intended
- `applied: false` — no-op, blocked, or failed (with `details.reason`)

### Highlight ack details

When `highlight-features` completes, the `command-ack` includes extra metadata in `details`:

| Field | Type | Description |
|-------|------|-------------|
| `featureCount` | `number` | Features actually highlighted |
| `exceededLimit` | `boolean` | `true` if the query hit the feature cap (more matching features exist) |
| `fieldNames` | `string[]` | Attribute field names from the highlighted features |
| `layerTitle` | `string` | Layer that was queried |
| `where` | `string` | SQL WHERE expression used |
| `geometryType` | `string` | `polygon`, `polyline`, `point`, or `unknown` |

sage-web surfaces `featureCount`, `exceededLimit`, `fieldNames`, `layerTitle`, and `where` in the tool output. This gives the AI enough metadata to decide whether a follow-up `query_map_features` call (stats, sample) would add value — without auto-sending potentially large attribute payloads.

## Screenshot pipeline

### Capture
1. Command executes (pan, zoom, highlight, layer toggle)
2. Wait for `view.updating === false`
3. Additional 200ms settle buffer
4. Capture via `view.takeScreenshot()` at 1092×1092 JPEG 75%

### Validation (parent side)
Before attaching to AI context, parent validates:
1. Valid image data URL format
2. Minimum base64 size threshold
3. Image decode succeeds
4. Minimum dimensions threshold

### Fallback
If validation fails:
1. Retry screenshot capture once
2. If still invalid, set `noVision = true` with reason
3. System prompt injects `NO_VISION_MARKER` — tells Claude not to make visual claims

## State model

```
MapStateSnapshot {
  center: { latitude, longitude }
  zoom: number
  scale: number
  extent: { xmin, ymin, xmax, ymax }
  rotation: number
  visibleLayers: string[]
  highlightedApns: string[]
  highlights: HighlightInfo[]      // Generic feature highlights
  preset: string
  webMapId: string
}

HighlightInfo {
  layerTitle?: string
  url: string
  where: string
  featureCount: number
  exceededLimit: boolean
  geometryType: 'polygon' | 'polyline' | 'point' | 'unknown'
  fieldNames: string[]
}
```

- Parent stores snapshots keyed by `mapId`
- `PANEL_MAP_ID` (`sage-canvas-map`) identifies the persistent side panel
- For relative operations (pan north 50%), parent reads current panel snapshot first

## Canonical source

<Warning>
The TypeScript types for this protocol live in **sage-map**:

```
sage-map/lib/shared/map-protocol/index.ts    ← CANONICAL (edit here)
sage-web/lib/shared/map-protocol/index.ts    ← COPY (must match)
```

After editing the canonical file, copy it to sage-web and run `npm test` in sage-web to verify the checksum matches. The sync test will fail on any divergence.
</Warning>

## Observability

Parent tracks reliability metrics:

| Metric | What it measures |
|--------|-----------------|
| `map.command-sent` | Command dispatched |
| `map.command-ack` | Ack received |
| `map.command-ack-latency` | Round-trip time |
| `map.command-ack-mismatch` | Ack for unexpected commandId |
| `screenshot.command-ack-timeout` | No ack within timeout |
| `screenshot.invalid` | Screenshot failed validation |
| `screenshot.retry-success` | Retry produced valid screenshot |
| `screenshot.retry-failed` | Both attempts failed → noVision |
